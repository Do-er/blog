---
title: "云数据库API"
date: "2019-11-20"
permalink: "2019-11-20-JS-SDK-db-collection"
---

### `db.collection`

获取一个集合的引用。

要操作一个集合，需先获取它的引用。在获取了数据库的引用后，可以通过数据库引用上的 `collection` 方法获取一个集合的引用。
```typescript
Collection.collection(name: string): Collection
```

方法接受一个 `string`类型的`name` 参数，指定需引用的集合名称。

### 示例代码
```javascript
import * as tcb from 'tcb-js-sdk';

// 获取数据库引用
const db = tcb.database();
// 获取集合引用
const todosCollection = db.collection('todos');
```

## `collection.doc`
获取记录的引用。

要操作一个记录，需先获取它的引用。在获取了集合的引用后，可以通过集合引用上的 `doc` 方法获取一个记录的引用。
```typescript
Collection.doc(id: string | number): Document
```
方法接受一个 `id` 参数，指定需引用的记录ID。

### 示例代码
```javascript
import * as tcb from 'tcb-js-sdk';

// 获取数据库引用
const db = tcb.database();
// 获取集合引用
const todosCollection = db.collection('todos');
// 获取记录引用
const myTodo = db.collection('todos').doc('my-todo-id');
```

## `collection.get`
获取集合数据，或获取根据查询条件筛选后的集合数据。

如果没有指定 `limit`，则默认最多取**20**条记录。

如果没有指定 `skip`，则默认从第**0**条记录开始取，`skip` 常用于分页，例子可见第二个示例代码。
```typescript
Collection.get(options?: object): Promise<Result>
```

### 参数说明
`options` 为可选参数，是一个如下格式的对象，如传入 `success`、`fail`、`complete` 三者之一，则表示使用回调风格，不返回 `Promise`对象。
|字段|类型|必填|默认值|说明|
|:--:|:--:|:--:|:--:|:--:|
|`success`|`Function`|否|-|成功回调，回调传入的参数 `Result` 包含查询的结果，`Result` 定义见下方|
|`fail`|`Function`|否|-|失败回调|
|`complete`|`Function`|否|-|调用结束的回调函数（调用成功、失败都会执行）|

### 返回值说明
如不传 `options` 参数，或传入的 `options` 参数没有 `success`、`fail`、`complete` 字段，则返回一个 `Promise`对象，否则不返回任何值。

`Promise` 的 `resolve` 和 `reject` 的结果定义如下：
- `resolve`：查询的结果，`Result` 定义见下方；
- `reject`：失败原因。

### `Result` 说明
`success` 回调的结果及 `Promise`对象`resolve` 的结果 `Result` 对象包含一个数组类型的`data`字段：
- `data` - `Array`：查询的结果数组，数据的每个元素是一个 Object，代表一条记录。

### 示例代码1 - 获取待办清单
回调风格：
```javascript
import * as tcb from 'tcb-js-sdk';

const db = tcb.database();
// 回调风格
db.collection('todos').where({
  _openid: 'xxx' // 填入当前用户 openid
}).get({
  success: function(res) {
    console.log(res.data)
  }
})
// Promise风格
db.collection('todos').where({
  _openid: 'xxx' // 填入当前用户 openid
}).get().then(res => {
  console.log(res.data)
})
```

### 示例代码2 - 分页取数据
获取我的第二页的待办事项清单，假设一页 10 条，现在要取第 2 页，则可以指定 `skip` 10 条记录
```javascript
import * as tcb from 'tcb-js-sdk';

const db = tcb.database();
db.collection('todos').where({
  _openid: 'xxx', // 填入当前用户 openid
})
.skip(10) // 跳过结果集中的前 10 条，从第 11 条开始返回
.limit(10) // 限制返回数量为 10 条
.get()
.then(res => {
  console.log(res.data)
})
.catch(err => {
  console.error(err)
});
```

## `collection.add`
在集合上新增记录。
```typescript
Collection.add(options: object): Promise<Result>
```

### 参数说明
`options` 为可选参数，是一个如下格式的对象，如传入 `success`、`fail`、`complete` 三者之一，则表示使用回调风格，不返回 `Promise`对象。
|字段|类型|必填|默认值|说明|
|:--:|:--:|:--:|:--:|:--:|
|`data`|`object`|是|-|新增记录的数据|
|`success`|`Function`|否|-|成功回调，回调传入的参数 `Result` 包含查询的结果，`Result` 定义见下方|
|`fail`|`Function`|否|-|失败回调|
|`complete`|`Function`|否|-|调用结束的回调函数（调用成功、失败都会执行）|

### 返回值说明
如不传 `options` 参数，或传入的 `options` 参数没有 `success`、`fail`、`complete` 字段，则返回一个 `Promise`对象，否则不返回任何值。

`Promise` 的 `resolve` 和 `reject` 的结果定义如下：
- `resolve`：查询的结果，`Result` 定义见下方；
- `reject`：失败原因。

### `Result` 说明
`success` 回调的结果及 `Promise`对象`resolve` 的结果 `Result` 对象包含一个`_id`字段：
- `_id` - `string|number`：新增的记录的 ID。

### 示例代码
```javascript
import * as tcb from 'tcb-js-sdk';

const db = tcb.database();
db.collection('todos').add({
  // data 字段表示需新增的 JSON 数据
  data: {
    description: "learn cloud database",
    due: new Date("2018-09-01"),
    tags: [
      "cloud",
      "database"
    ],
    location: new db.Geo.Point(113, 23),
    done: false
  }
})
.then(res => {
  console.log(res)
})
.catch(console.error);
```

## `collection.watch`
监听集合中符合查询条件的数据的更新事件。注意使用 `watch` 时，**只有 `where` 语句会生效**，`orderBy`、`limit` 等不生效。
```typescript
Collection.watch(options?: object): Watcher
```

### 参数说明
`options` 为可选参数，是一个如下格式的对象：
|字段|类型|必填|默认值|说明|
|:--:|:--:|:--:|:--:|:--:|
|`onChange`|`Function`|是|-|成功回调，回调传入的参数 `snapshot` 是变更快照，`snapshot` 定义见下方|
|`onError`|`Function`|是|-|失败回调|

### `snapshot`说明
|字段|类型|说明|
|:--:|:--:|:--:|
|`docChanges`|`ChangeEvent[]`|更新事件数组|
|`docs`|`object[]`|数据快照，表示此更新事件发生后查询语句对应的查询结果|
|`type`|`string`|快照类型，仅在第一次初始化数据时有值为 init|
|`id`|`number`|变更事件 id|

### `ChangeEvent`说明
|字段|类型|说明|
|:--:|:--:|:--:|
|`id`|`number`|变更事件 id|
|`queueType`|`string`|列表更新类型，表示更新事件对监听列表的影响，枚举值，定义见 `QueueType`|
|`dataType`|`string`|数据更新类型，表示记录的具体更新类型，枚举值，定义见 `DataType`|
|`docId`|`string`|更新的记录 id|
|`doc`|`object`|更新的完整记录|
|`updatedFields`|`object`|所有更新的字段及字段更新后的值，`key` 为更新的字段路径，`value` 为字段更新后的值，仅在 `update` 操作时有此信息|
|`removedFields`|`string[]`|所有被删除的字段，仅在 `update` 操作时有此信息|

### `QueueType`枚举值
|字段|说明|
|:--:|:--:|
|`init`|初始化列表|
|`update`|列表中的记录内容有更新，但列表包含的记录不变|
|`enqueue`|记录进入列表|
|`dequeue`|记录离开列表|

### `DataType`枚举值
|字段|说明|
|:--:|:--:|
|`init`|初始化数据|
|`update`|记录内容更新，对应 `update` 操作|
|`replace`|记录内容被替换，对应 `set` 操作|
|`add`|记录离记录新增，对应 `add` 操作开列表|
|`remove`|记录被删除，对应 `remove` 操作|

### 返回值`Watcher`对象
`Watcher` 上只有一个 `close` 方法，可以用于关闭监听。

### 示例代码1 - 根据查询条件监听
```javascript
import * as tcb from 'tcb-js-sdk';

const db = tcb.database();
const watcher = db.collection('todos').where({
  _openid: 'xxx' // 填入当前用户 openid
}).watch({
  onChange: function(snapshot) {
    console.log('snapshot', snapshot)
  },
  onError: function(err) {
    console.error('the watch closed because of error', err)
  }
});
```

### 示例代码2 - 监听一个记录的变化
```javascript
import * as tcb from 'tcb-js-sdk';

const db = tcb.database();
const watcher = db.collection('todos').doc('x').watch({
  onChange: function(snapshot) {
    console.log('snapshot', snapshot)
  },
  onError: function(err) {
    console.error('the watch closed because of error', err)
  }
});
```

### 示例代码3 - 关闭监听
```javascript
import * as tcb from 'tcb-js-sdk';

const db = tcb.database();
const watcher = db.collection('todos').where({
  _openid: 'xxx' // 填入当前用户 openid
}).watch({
  onChange: function(snapshot) {
    console.log('snapshot', snapshot)
  },
  onError: function(err) {
    console.error('the watch closed because of error', err)
  }
});
// ...
// 关闭
watcher.close();
```

## `collection.count/query.count`
统计集合记录数或统计查询语句对应的结果记录数，注意这与集合权限设置有关，一个用户仅能统计其有**读权限**的记录数。
```typescript
Collection.count(options?: object): Promise<Result> 
```

### 参数说明
`options` 为可选参数，是一个如下格式的对象，如传入 `success`、`fail`、`complete` 三者之一，则表示使用回调风格，不返回 `Promise`对象。
|字段|类型|必填|默认值|说明|
|:--:|:--:|:--:|:--:|:--:|
|`success`|`Function`|否|-|成功回调，回调传入的参数 `Result` 包含查询的结果，`Result` 定义见下方|
|`fail`|`Function`|否|-|失败回调|
|`complete`|`Function`|否|-|调用结束的回调函数（调用成功、失败都会执行）|

### 返回值说明
如不传 `options` 参数，或传入的 `options` 参数没有 `success`、`fail`、`complete` 字段，则返回一个 `Promise`对象，否则不返回任何值。

`Promise` 的 `resolve` 和 `reject` 的结果定义如下：
- `resolve`：查询的结果，`Result` 定义见下方；
- `reject`：失败原因。

### `Result` 说明
`success` 回调的结果及 `Promise`对象`resolve` 的结果 `Result` 对象包含一个`total`字段：
- `total` - `number`：结果数量。

### 示例代码 - 获取我的待办事项总数
```javascript
import * as tcb from 'tcb-js-sdk';

const db = tcb.database();
db.collection('todos').where({
  _openid: 'xxx' // 填入当前用户 openid
}).count().then(res => {
  console.log(res.total)
});
```

## `collection.where`
指定筛选条件。
```typescript
Collection.where(rule: object): Query
```
方法接受一个必填对象参数 `rule`，用于定义筛选条件。

### 示例代码
```javascript
import * as tcb from 'tcb-js-sdk';

const db = tcb.database();
db.collection('todos').where({
  done: false,
  progress: 50
})
.get()
.then(res => {
  console.log(res)
})
.catch(console.error);
```

## `collection.orderBy`
指定查询排序条件。
```typescript
Collection.orderBy(fieldName: string, order: string): Collection | Query
```
方法接受一个必填字符串参数 `fieldName` 用于定义需要排序的字段，一个字符串参数 `order` 定义排序顺序，可取值如下：
- `asc`：升序排列
- `desc`：降序排列。

如果需要对嵌套字段排序，需要用 "*点表示法*" 连接嵌套字段，比如 `style.color` 表示字段 `style` 里的嵌套字段 `color`。

同时也支持按多个字段排序，多次调用 `orderBy` 即可，多字段排序时的顺序会按照 `orderBy` **调用顺序**先后对多个字段排序。

### 示例代码1 - 按一个字段排序
```javascript
import * as tcb from 'tcb-js-sdk';

const db = tcb.database();
db.collection('todos')
  .orderBy('progress', 'asc')
  .get()
  .then(console.log)
  .catch(console.error);
```

### 示例代码2 - 按多个字段排序
```javascript
import * as tcb from 'tcb-js-sdk';

const db = tcb.database();
db.collection('todos')
  .orderBy('progress', 'desc')
  .orderBy('description', 'asc')
  .get()
  .then(console.log)
  .catch(console.error);
```

## `collection.limit`
指定查询结果集数量上限。
```typescript
Collection.limit(max: number): Collection | Query
```
方法接受一个必填参数 `max` 用于定义最大结果集返回数量，上限 **20**。

### 示例代码
```javascript
import * as tcb from 'tcb-js-sdk';

const db = tcb.database();
db.collection('todos').limit(10)
  .get()
  .then(console.log)
  .catch(console.error);
```

## `collection.skip`
指定查询返回结果时从指定序列后的结果开始返回，常用于分页。
```typescript
Collection.skip(offset: number): Collection | Query
```

### 示例代码
```javascript
import * as tcb from 'tcb-js-sdk';

const db = tcb.database();
db.collection('todos').skip(10)
  .get()
  .then(console.log)
  .catch(console.error);
```

## `collection.field`
指定返回结果中记录需返回的字段。
```typescript
Collection.field(definition: object): Collection | Query | Document
```

方法接受一个必填对象`definition`用于指定需返回的字段，对象的key-value作用如下：
- `key` 表示要返回或不要返回的字段；
- `value` 传入 `true`|`false`（或 `1`|`-1`）表示要返回还是不要返回。

如果指定的字段是数组字段，还可以有以下技巧：
- 在该字段 `key` 后面拼接上 `.$` 成为 `字段.$` 的形式，这样只会返回数组的**第一个元素**；
- 用 `db.command.project.slice` 方法返回数组的**子数组**，具体使用方案如下：
  - 接收一个**正数**表示返回前 `n` 个元素。比如返回数组的前 5 个元素：`{ tags: db.command.project.slice(5) }`；
  - 接收一个**负数**表示返回后 `n` 个元素。比如返回数组的后 5 个元素：`{ tags: db.command.project.slice(-5) }`；
  - 接收一个包含两个数字 `[ skip, limit ]` 的数组
    - 如果 `skip` 是正数，表示跳过 `skip` 个元素后再返回接下来的 `limit` 个元素。比如跳过前 5 个元素，返回接下来 10 个元素：`{ tags: db.command.project.slice(5, 10) }`；
    - 如果 `skip` 是负数，表示从倒数第 `skip` 个元素开始，返回往后数的 `limit` 个元素。比如从倒数第 5 个元素开始，返回接下来正方向数的 10 个元素：`{ tags: db.command.project.slice(-5, 10) }`。

### 示例代码 - 返回 `description`, `done` 和 `progress` 三个字段
```javascript
import * as tcb from 'tcb-js-sdk';

const db = tcb.database();
db.collection('todos').field({
  description: true,
  done: true,
  progress: true,
  // 只返回 tags 数组前 3 个元素
  tags: db.command.project.slice(3),
})
.get()
.then(console.log)
.catch(console.error);
```

## `collection.aggregate`
发起聚合操作，定义完聚合流水线阶段之后需调用 `end` 方法标志结束定义并实际发起聚合操作
```typescript
Collection.aggregate(): Aggregate
```

### 返回值
[`Aggregate`]()对象。

### 示例代码
```javascript
import * as tcb from 'tcb-js-sdk';

const db = tcb.database();
// 聚合操作符，详见[聚合操作符]()
const $ = db.command.aggregate
db.collection('books').aggregate()
  .group({
    // 按 category 字段分组
    _id: '$category',
    // 让输出的每组记录有一个 avgSales 字段，其值是组内所有记录的 sales 字段的平均值
    avgSales: $.avg('$sales')
  })
  .end()
  .then(res => console.log(res))
  .catch(err => console.error(err))
```