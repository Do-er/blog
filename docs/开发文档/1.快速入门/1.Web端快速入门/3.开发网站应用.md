---
title: '开通网站应用'
date: '2019-09-03'
permalink: '2019-09-03-web-dev-guide-develop'
---

# 使用云开发进行Web应用开发

本文档主要介绍如何使用 SDK 主要操作进行开发，更多详情可参考开发指南。

## 初始化

若需要使用云开发的其他能力，需要先进行初始化。示例代码如下：

```html
<script src="https://imgcache.qq.com/qcloud/tcbjs/$version/tcb.js"></script>
<script>
  tcb.init({
    env: 'example-envid' //当前环境ID
  })
</script>
```
- `$version` 为JavaScript SDK的版本号，最新的版本号可以从[云开发控制台](https://console.cloud.tencent.com/tcb/overview)查询，具体位置如下图所示：

<img src="/images/web/jssdk-version-control.png" style="width:500px;"/>

- `example-envid`为环境ID，同样从云开发控制台获取，具体位置如下图所示：

<img src="/images/web/env-id-control.png" style="width:400px;"/>

## 登录授权

初始化完成后，您需要完成登录授权才可使用云开发。

### 微信登录授权
在云开发控制台中[开启微信登录授权](/2019-09-03-web-dev-guide-service/#设置登录授权方式)之后，参照以下代码在客户端使用tcb-js-sdk进行登录：
```javascript
import * as tcb from 'tcb-js-sdk';

const app = tcb.init({
  env: 'example-envid'
});

const auth = app.auth();
auth.weixinAuthProvider({
  appid: 'example-appid', //微信应用appid
  scope: 'snsapi_type' //网页授权类型
}).signIn((err, res) => {});
```

- 将代码中 `'example-appid'` 修改为您微信应用的`appid`。
- `snsapi_type`为网页授权类型，可选值有以下三种：
  - `snsapi_base`：微信公众平台，只获取用户的`openid`；
  - `snsapi_userinfo`：微信公众平台，获取用户的基本信息；
  - `snsapi_login`：微信开放平台网页授权。

### 自定义登录授权
请参阅[自定义登录授权](/2019-09-03-web-dev-guide-service/#自定义登录授权)。

:::tip
详细登录API文档见[tcb.auth API](/2019-09-28-WEB-SDK-authentication/)
:::

### 获取用户信息
任何方式登录成功后，可以调用`getUserInfo`获得用户的 Cloudbase 身份信息。

#### 请求参数
无

#### 响应参数
|字段| 类型| 是否必备| 说明|
|:--:|:--:|:--:|--|
|uid| string| 是| 用户在云开发的唯一ID|
|appid| string| 是| 微信（开放平台或公众平台）应用appid|
|openid| string| 是| 当前用户在微信（开放平台或公众平台）应用的openid|
|nickName| string| 否| 用户昵称|
|gender| string| 否| 用户性别，male（男）或female（女）|
|country| string| 否| 用户所在国家|
|province| string| 否| 用户所在省份|
|city| string| 否 |用户所在城市|
|avatarUrl| string| 否| 用户头像链接|

#### 示例代码
```javascript
tcb.init({
  env: 'xxxx-yyy'
});

const auth = tcb.auth({
  persistence: 'session'
})
auth
  .weixinAuthProvider({
    appid: 'wx73932328juof23',
    scope: 'snsapi_userinfo'
  })
  // 先登录才能拿到用户信息
  .signIn()
  .then(() => {
    // 获取用户信息
    return auth.getUserInfo()
  })
  .then(userInfo => {
    //...
  })
```

#### 登录授权相关事件及钩子函数
##### Event: 'loginStateExpire'
当登录态失效时，会触发这个事件，开发者可以在这个事件回调内，尝试重新登录 Cloudbase。

```javascript
tcb.on('loginStateExpire', () => {
  // 尝试重新登录
  tcb.auth().weixinAuthProvider({
    appid: 'wx73932328juof23',
    scope: 'snsapi_base'
  }).signIn().then(() => {
    // 登录成功
  }).catch(err => {
    // 登录失败
  });
});
```
##### Event: 'refreshAccessToken'
JS SDK 会在登录态生效期间，自动刷新和维护短期访问令牌（access token），每次成功刷新时会触发此事件。

对于两种登录态并存（Cloudbase、自身业务登录态）的 Web 应用，这个事件可以用于同步登录态之间的状态。
```javascript
tcb.on('refreshAccessToken', () => {
  // 此时 Cloudbase 短期访问令牌已经刷新，可以尝试刷新自身业务的登录态
})
```
##### Auth.shouldRefreshAccessToken(callback)
`shouldRefreshAccessToken` 接收一个 callback 函数，并且会在刷新短期访问令牌前调用此 callback 函数，根据返回值决定是否要刷新短期访问令牌。

对于两种登录态并存（Cloudbase、自身业务登录态）的 Web 应用，可以在 callback 内判断自身业务登录态是否失效，从而决定是否续期 Cloudbase 的短期访问令牌。
```javascript
auth.shouldRefreshAccessToken(() => {
  if (/* 自身业务登录态还有效 */) {
    return true;
  } else {
    return false;
  }
});
```
## 操作数据库

您可以完成对数据库基础的 CRUD 及服务端时间（serverDate）、正则查找（regExp）和地理位置（geo）等特殊数据结构的使用。示例代码如下：

```javascript
var db = app.database();

db.collection('blog')
  .get()
  .then(res => {
    var data = res.data;
    console.log(data);
  });
```

更多详情请参考数据库相关 [开发指南](/2019-09-03-clouddatabase-summary/)。

## 操作文件存储

您可以完成文件上传、获取下载链接或者删除文件等操作。示例代码如下：

```javascript
// 上传文件
app.uploadFile({
  filePath: (<HTMLInputElement>document.getElementById('file')).files[0],
  cloudPath: 'cos.jpeg',
  onUploadProgress: (progressEvent) => {
    let percentCompleted = Math.round((progressEvent.loaded * 100) / progressEvent.total);
    console.log('uploadFile progress: ' + percentCompleted, progressEvent);
  }
}, function (err, res) {

});

// 获取下载链接
app.getTempFileURL({
  fileList: ['cloud://example.jpeg']    //fileid
}, (err, res) => {
  res.fileList && res.fileList.length
  && res.fileList.map(item => {
    console.log(item.download_url)
  });
});
```

:::tip

您需要将代码中的 cloud://example.jpeg 修改为文件的 fileid 。

:::

更多详情请参考文件存储相关 [开发指南](/2019-09-03-cloudstorage-summary/)。

## 操作云函数

您可以对云函数的安全调用。示例代码如下：

```javascript
//调用云函数
app.callFunction({ name: 'test', data: { hello: 'world' }, function(err, res) {

}};
```

更多详情请参考云函数相关 [开发指南](/2019-09-03-cloudfunction-summary/)。

### 阅读更多
- [云开发控制台](/2019-09-03-web-dev-guide-console/)
- [tcb-js-sdk](/2019-09-28-WEB-SDK-overview/)
- [tcb-admin-node](/2019-09-28-NODEJS-SDK-overview/)